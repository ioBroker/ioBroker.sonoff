{"version":3,"file":"main.js","sourceRoot":"","sources":["../src/main.ts"],"names":[],"mappings":";;;;;;AAAA;;;;;;GAMG;AACH,yDAAsE,CAAC,wBAAwB;AAC/F,0DAAkC;AAGlC,MAAa,aAAc,SAAQ,sBAAO;IAEtC,MAAM,GAAkB,IAAI,CAAC;IAE7B,YAAmB,UAAmC,EAAE;QACpD,KAAK,CAAC;YACF,GAAG,OAAO;YACV,IAAI,EAAE,QAAQ;YACd,KAAK,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,IAAI,EAAE;YACxB,MAAM,EAAE,KAAK,EAAE,EAAe,EAAiB,EAAE;gBAC7C,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;oBACd,MAAM,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;oBAC5B,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;gBACvB,CAAC;gBACD,IAAI,OAAO,EAAE,KAAK,UAAU,EAAE,CAAC;oBAC3B,EAAE,EAAE,CAAC;gBACT,CAAC;YACL,CAAC;YACD,WAAW,EAAE,CAAC,EAAU,EAAE,KAAwC,EAAQ,EAAE;gBACxE,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,eAAe,EAAE,KAAK,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;gBAC9D,yEAAyE;gBACzE,IAAI,KAAK,IAAI,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC;oBACtB,IAAI,CAAC,MAAM;wBACP,EAAE,aAAa,CAAC,EAAE,EAAE,KAAK,CAAC;yBACzB,KAAK,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,gCAAgC,GAAG,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC;gBACrF,CAAC;YACL,CAAC;SACJ,CAAC,CAAC;IACP,CAAC;IAEO,KAAK,CAAC,IAAI;QACd,kCAAkC;QAClC,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC;QAE1B,yCAAyC;QACzC,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC;QACnD,IAAI,MAAM,EAAE,MAAM,EAAE,CAAC;YACjB,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE,CAAC;gBACzB,IAAI,KAAK,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,CAAC,EAAE,CAAC;oBAC9B,MAAM,IAAI,CAAC,oBAAoB,CAAC,KAAK,CAAC,GAAG,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC;gBAC5D,CAAC;YACL,CAAC;QACL,CAAC;QAED,IAAI,CAAC,MAAM,GAAG,IAAI,gBAAM,CAAC,IAAwB,CAAC,CAAC;IACvD,CAAC;CACJ;AA9CD,sCA8CC;AAED,IAAI,OAAO,CAAC,IAAI,KAAK,MAAM,EAAE,CAAC;IAC1B,yCAAyC;IACzC,MAAM,CAAC,OAAO,GAAG,CAAC,OAA4C,EAAE,EAAE,CAAC,IAAI,aAAa,CAAC,OAAO,CAAC,CAAC;AAClG,CAAC;KAAM,CAAC;IACJ,wCAAwC;IACxC,CAAC,GAAG,EAAE,CAAC,IAAI,aAAa,EAAE,CAAC,EAAE,CAAC;AAClC,CAAC","sourcesContent":["/**\n *      ioBroker sonoff Adapter\n *\n *      (c) 2017-2026 bluefox\n *\n *      MIT License\n */\nimport { Adapter, type AdapterOptions } from '@iobroker/adapter-core'; // Get common this utils\nimport Server from './lib/server';\nimport type { SonoffAdapterConfig } from './types';\n\nexport class SonoffAdapter extends Adapter {\n    declare config: SonoffAdapterConfig;\n    server: Server | null = null;\n\n    public constructor(options: Partial<AdapterOptions> = {}) {\n        super({\n            ...options,\n            name: 'sonoff',\n            ready: () => this.main(),\n            unload: async (cb?: () => void): Promise<void> => {\n                if (this.server) {\n                    await this.server.destroy();\n                    this.server = null;\n                }\n                if (typeof cb === 'function') {\n                    cb();\n                }\n            },\n            stateChange: (id: string, state: ioBroker.State | null | undefined): void => {\n                this.log.debug(`stateChange ${id}: ${JSON.stringify(state)}`);\n                // you can use the ack flag to detect if state is desired or acknowledged\n                if (state && !state.ack) {\n                    this.server\n                        ?.onStateChange(id, state)\n                        .catch(err => this.log.error(`Cannot process state change: ${err.message}`));\n                }\n            },\n        });\n    }\n\n    private async main(): Promise<void> {\n        // subscribe for all own variables\n        this.subscribeStates('*');\n\n        // read all states and set alive to false\n        const states = await this.getStatesOfAsync('', '');\n        if (states?.length) {\n            for (const state of states) {\n                if (state._id.match(/\\.alive$/)) {\n                    await this.setForeignStateAsync(state._id, false, true);\n                }\n            }\n        }\n\n        this.server = new Server(this as ioBroker.Adapter);\n    }\n}\n\nif (require.main !== module) {\n    // Export the constructor in compact mode\n    module.exports = (options: Partial<AdapterOptions> | undefined) => new SonoffAdapter(options);\n} else {\n    // otherwise start the instance directly\n    (() => new SonoffAdapter())();\n}\n"]}