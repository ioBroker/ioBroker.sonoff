{"version":3,"file":"main.js","sourceRoot":"","sources":["../src/main.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n *      ioBroker sonoff Adapter\n *\n *      (c) 2017-2026 bluefox\n *\n *      MIT License\n */\nimport { Adapter, type AdapterOptions } from '@iobroker/adapter-core';\nimport Server from './lib/server';\nimport MQTTClientWrapper from './lib/client';\nimport types from './lib/datapoints';\nimport type { SonoffAdapterConfig } from './types';\n\nconst FORBIDDEN_CHARS = /[\\]\\\\[*,;'\"`<>\\\\?]/g;\n\nexport class SonoffAdapter extends Adapter {\n    declare config: SonoffAdapterConfig;\n    server: Server | null = null;\n    private mqttClient: MQTTClientWrapper | null = null;\n    private clientDevices: { [deviceId: string]: { connected: boolean } } = {};\n\n    public constructor(options: Partial<AdapterOptions> = {}) {\n        super({\n            ...options,\n            name: 'sonoff',\n            ready: () => this.main(),\n            unload: async (cb?: () => void): Promise<void> => {\n                if (this.server) {\n                    await this.server.destroy();\n                    this.server = null;\n                }\n                if (this.mqttClient) {\n                    this.mqttClient.disconnect();\n                    this.mqttClient = null;\n                }\n                if (typeof cb === 'function') {\n                    cb();\n                }\n            },\n            stateChange: (id: string, state: ioBroker.State | null | undefined): void => {\n                this.log.debug(`stateChange ${id}: ${JSON.stringify(state)}`);\n                if (state && !state.ack) {\n                    const mode = this.config.mode || 'server';\n                    if (mode === 'client') {\n                        this.onClientStateChange(id, state).catch(err =>\n                            this.log.error(`Cannot process state change: ${err.message}`),\n                        );\n                    } else {\n                        this.server\n                            ?.onStateChange(id, state)\n                            .catch(err => this.log.error(`Cannot process state change: ${err.message}`));\n                    }\n                }\n            },\n        });\n    }\n\n    private async main(): Promise<void> {\n        this.subscribeStates('*');\n\n        // read all states and set alive to false\n        const states = await this.getStatesOfAsync('', '');\n        if (states?.length) {\n            for (const state of states) {\n                if (state._id.match(/\\.alive$/)) {\n                    await this.setForeignStateAsync(state._id, false, true);\n                }\n            }\n        }\n\n        const mode = this.config.mode || 'server';\n\n        if (mode === 'client') {\n            this.log.info('Starting in CLIENT mode - connecting to external MQTT broker');\n            await this.startClientMode();\n        } else {\n            this.log.info('Starting in SERVER mode - built-in MQTT broker');\n            this.server = new Server(this as ioBroker.Adapter);\n        }\n    }\n\n    // =====================================================================\n    //  CLIENT MODE - Connect to external MQTT broker\n    // =====================================================================\n    private async startClientMode(): Promise<void> {\n        // Ensure info.connection object exists before setting state\n        await this.setObjectNotExistsAsync('info.connection', {\n            type: 'state',\n            common: {\n                name: 'Connected to MQTT broker',\n                type: 'boolean',\n                role: 'indicator.connected',\n                read: true,\n                write: false,\n            },\n            native: {},\n        });\n        await this.setStateAsync('info.connection', false, true);\n\n        const brokerUrl = this.config.brokerUrl || 'localhost';\n        const brokerPort = parseInt(this.config.brokerPort as string, 10) || 1883;\n        const useTls = this.config.brokerUseTls || false;\n        const protocol = useTls ? 'mqtts' : 'mqtt';\n        const url = `${protocol}://${brokerUrl}:${brokerPort}`;\n\n        this.mqttClient = new MQTTClientWrapper(this as ioBroker.Adapter, {\n            url,\n            user: this.config.brokerUser || '',\n            password: this.config.brokerPassword || '',\n            clientId: this.config.brokerClientId || `iobroker_sonoff_${this.instance}`,\n            useTls,\n            rejectUnauthorized: this.config.brokerTlsRejectUnauthorized !== false,\n            caPath: this.config.brokerCaPath || '',\n            certPath: this.config.brokerCertPath || '',\n            keyPath: this.config.brokerKeyPath || '',\n            topicPrefix: this.config.brokerTopicPrefix || '',\n            topicStructure: this.config.brokerTopicStructure || 'standard',\n            keepalive: parseInt(this.config.brokerKeepalive as string, 10) || 60,\n            reconnectPeriod: parseInt(this.config.brokerReconnectPeriod as string, 10) || 5000,\n            cleanSession: this.config.brokerCleanSession !== false,\n        });\n\n        this.mqttClient.onMessage = (topic: string, message: string, deviceId: string): void => {\n            this.processExternalMessage(topic, message, deviceId).catch(err =>\n                this.log.error(`Cannot process MQTT message: ${err.message}`),\n            );\n        };\n\n        this.mqttClient.onConnected = (): void => {\n            this.log.info('Connected to external MQTT broker');\n            this.setState('info.connection', true, true);\n        };\n\n        this.mqttClient.onDisconnected = (): void => {\n            this.log.warn('Disconnected from external MQTT broker');\n            this.setState('info.connection', false, true);\n        };\n\n        this.mqttClient.onError = (err: Error): void => {\n            this.log.error(`MQTT client error: ${err.message}`);\n        };\n\n        this.mqttClient.onDeviceOnline = (deviceId: string): void => {\n            this.log.info(`Device [${deviceId}] detected via external MQTT broker`);\n            this.clientDevices[deviceId] = { connected: true };\n            this.setDeviceOnline(deviceId, true).catch(err =>\n                this.log.error(`Cannot set device online: ${err.message}`),\n            );\n        };\n\n        try {\n            await this.mqttClient.connect();\n        } catch (err: any) {\n            this.log.error(`Cannot connect to external MQTT broker: ${err.message}`);\n        }\n    }\n\n    // =====================================================================\n    //  External MQTT message processing (client mode)\n    // =====================================================================\n    private async processExternalMessage(topic: string, message: string, _deviceId: string): Promise<void> {\n        this.log.debug(`MQTT message: ${topic} = ${message}`);\n\n        const parts = topic.split('/');\n        if (parts.length < 3) {\n            this.log.debug(`Ignoring short topic: ${topic}`);\n            return;\n        }\n\n        const prefix = parts[0]; // tele, stat, cmnd\n        const device = parts[1]; // device name\n        const command = parts.slice(2).join('/');\n        const deviceId = device.replace(FORBIDDEN_CHARS, '_');\n\n        // Ensure device is tracked\n        if (!this.clientDevices[deviceId]) {\n            this.clientDevices[deviceId] = { connected: true };\n            await this.setDeviceOnline(deviceId, true);\n        }\n\n        if (prefix === 'tele') {\n            await this.processTelemetry(deviceId, command, message);\n        } else if (prefix === 'stat') {\n            await this.processStatus(deviceId, command, message);\n        } else {\n            this.log.debug(`Unknown prefix \"${prefix}\" in topic \"${topic}\"`);\n        }\n    }\n\n    private async processTelemetry(deviceId: string, command: string, message: string): Promise<void> {\n        if (command === 'LWT') {\n            const isOnline = message === 'Online';\n            await this.setDeviceOnline(deviceId, isOnline);\n            if (isOnline) {\n                this.clientDevices[deviceId] = { connected: true };\n            }\n            return;\n        }\n\n        if (command === 'STATE') {\n            if (!this.config.TELE_STATE) {\n                return;\n            }\n            try {\n                const stateObj = JSON.parse(message);\n                await this.processStateObject(deviceId, stateObj);\n            } catch {\n                this.log.warn(`Cannot parse tele STATE from ${deviceId}`);\n            }\n            return;\n        }\n\n        if (command === 'SENSOR') {\n            if (!this.config.TELE_SENSOR) {\n                return;\n            }\n            try {\n                const sensorObj = JSON.parse(message);\n                await this.processStateObject(deviceId, sensorObj);\n            } catch {\n                this.log.warn(`Cannot parse tele SENSOR from ${deviceId}`);\n            }\n            return;\n        }\n\n        if (command === 'RESULT') {\n            try {\n                const resultObj = JSON.parse(message);\n                await this.processStateObject(deviceId, resultObj);\n            } catch {\n                this.log.warn(`Cannot parse tele RESULT from ${deviceId}`);\n            }\n            return;\n        }\n\n        if (command === 'ENERGY') {\n            try {\n                const energyObj = JSON.parse(message);\n                await this.processStateObject(deviceId, energyObj, 'ENERGY');\n            } catch {\n                this.log.warn(`Cannot parse tele ENERGY from ${deviceId}`);\n            }\n            return;\n        }\n\n        if (command === 'MARGINS') {\n            try {\n                const marginsObj = JSON.parse(message);\n                await this.processStateObject(deviceId, marginsObj, 'MARGINS');\n            } catch {\n                this.log.warn(`Cannot parse tele MARGINS from ${deviceId}`);\n            }\n            return;\n        }\n\n        if (command.startsWith('INFO')) {\n            try {\n                const infoObj = JSON.parse(message);\n                await this.processStateObject(deviceId, infoObj, command);\n            } catch {\n                this.log.debug(`Cannot parse tele ${command} from ${deviceId}`);\n            }\n            return;\n        }\n\n        // Other telemetry messages (WAKEUP, etc.)\n        try {\n            const obj = JSON.parse(message);\n            await this.processStateObject(deviceId, obj, command);\n        } catch {\n            // Not JSON, store as string\n            await this.setTasmotaState(deviceId, command, message);\n        }\n    }\n\n    private async processStatus(deviceId: string, command: string, message: string): Promise<void> {\n        if (command === 'RESULT') {\n            if (!this.config.STAT_RESULT) {\n                return;\n            }\n            try {\n                const resultObj = JSON.parse(message);\n                await this.processStateObject(deviceId, resultObj);\n            } catch {\n                this.log.warn(`Cannot parse stat RESULT from ${deviceId}`);\n            }\n            return;\n        }\n\n        // POWER, POWER1, POWER2, etc.\n        if (command.startsWith('POWER')) {\n            const val = message === 'ON' || message === '1' || message === 'true';\n            await this.setTasmotaState(deviceId, command, val);\n            return;\n        }\n\n        // STATUS responses (STATUS0..STATUS11)\n        if (command.startsWith('STATUS')) {\n            try {\n                const statusObj = JSON.parse(message);\n                await this.processStateObject(deviceId, statusObj, command);\n            } catch {\n                this.log.debug(`Cannot parse stat ${command} from ${deviceId}`);\n            }\n            return;\n        }\n\n        // Other stat messages\n        try {\n            const obj = JSON.parse(message);\n            await this.processStateObject(deviceId, obj, command);\n        } catch {\n            await this.setTasmotaState(deviceId, command, message);\n        }\n    }\n\n    private async processStateObject(\n        deviceId: string,\n        obj: Record<string, any>,\n        parentPath?: string,\n    ): Promise<void> {\n        if (!obj || typeof obj !== 'object') {\n            return;\n        }\n\n        for (const key of Object.keys(obj)) {\n            const val = obj[key];\n            const path = parentPath ? `${parentPath}_${key}` : key;\n\n            if (val !== null && typeof val === 'object' && !Array.isArray(val)) {\n                if (this.config.OBJ_TREE) {\n                    await this.processStateObject(deviceId, val, path);\n                } else {\n                    // Flatten using underscore separator\n                    await this.processStateObject(deviceId, val, path);\n                }\n            } else {\n                await this.setTasmotaState(deviceId, path, val);\n            }\n        }\n    }\n\n    private async setTasmotaState(deviceId: string, stateKey: string, value: any): Promise<void> {\n        // Ensure device object exists\n        await this.setObjectNotExistsAsync(deviceId, {\n            type: 'device',\n            common: { name: deviceId },\n            native: {},\n        });\n\n        // Check for known datapoint definition\n        const dpDef = (types as Record<string, any>)[stateKey];\n\n        let processedValue = value;\n        let type: string = typeof value;\n        if (type === 'object') {\n            processedValue = JSON.stringify(value);\n            type = 'string';\n        }\n\n        let common: ioBroker.StateCommon;\n        if (dpDef) {\n            common = {\n                name: stateKey,\n                type: dpDef.type === 'mixed' ? 'string' : dpDef.type === 'array' ? 'string' : dpDef.type,\n                role: dpDef.role,\n                read: dpDef.read,\n                write: dpDef.write,\n            };\n            if (dpDef.unit) {\n                common.unit = dpDef.unit;\n            }\n            if (dpDef.min !== undefined) {\n                common.min = dpDef.min;\n            }\n            if (dpDef.max !== undefined) {\n                common.max = dpDef.max;\n            }\n            if (dpDef.states) {\n                common.states = dpDef.states;\n            }\n        } else {\n            common = {\n                name: stateKey,\n                type: type === 'boolean' ? 'boolean' : type === 'number' ? 'number' : 'string',\n                role: type === 'boolean' ? 'switch' : type === 'number' ? 'value' : 'text',\n                read: true,\n                write: false,\n            };\n        }\n\n        // Create folder structure for object tree mode\n        if (this.config.OBJ_TREE) {\n            const parts = stateKey.split('_');\n            let path = deviceId;\n            for (let i = 0; i < parts.length - 1; i++) {\n                path += `.${parts[i]}`;\n                await this.setObjectNotExistsAsync(path, {\n                    type: 'channel',\n                    common: { name: parts[i] },\n                    native: {},\n                });\n            }\n        }\n\n        const stateObjId = this.config.OBJ_TREE ? `${deviceId}.${stateKey.replace(/_/g, '.')}` : `${deviceId}.${stateKey}`;\n\n        await this.setObjectNotExistsAsync(stateObjId, {\n            type: 'state',\n            common,\n            native: {},\n        });\n\n        // Convert value to correct type\n        if (common.type === 'boolean') {\n            processedValue =\n                value === true || value === 'ON' || value === '1' || value === 'true' || value === 1;\n        } else if (common.type === 'number') {\n            processedValue = parseFloat(value);\n            if (isNaN(processedValue)) {\n                processedValue = 0;\n            }\n        } else {\n            processedValue = String(value ?? '');\n        }\n\n        await this.setStateAsync(stateObjId, { val: processedValue, ack: true });\n    }\n\n    private async setDeviceOnline(deviceId: string, online: boolean): Promise<void> {\n        await this.setObjectNotExistsAsync(deviceId, {\n            type: 'device',\n            common: { name: deviceId },\n            native: {},\n        });\n\n        await this.setObjectNotExistsAsync(`${deviceId}.alive`, {\n            type: 'state',\n            common: {\n                name: 'Device online',\n                type: 'boolean',\n                role: 'indicator.reachable',\n                read: true,\n                write: false,\n            },\n            native: {},\n        });\n\n        await this.setStateAsync(`${deviceId}.alive`, { val: online, ack: true });\n    }\n\n    // =====================================================================\n    //  State change handling for client mode (send commands to Tasmota)\n    // =====================================================================\n    private async onClientStateChange(id: string, state: ioBroker.State): Promise<void> {\n        if (!this.mqttClient) {\n            return;\n        }\n\n        // id format: sonoff.0.<deviceId>.<stateKey>\n        const parts = id.split('.');\n        if (parts.length < 4) {\n            return;\n        }\n\n        const deviceId = parts[2];\n        const stateKey = parts.slice(3).join('.');\n\n        // Build MQTT command\n        let command = stateKey;\n        let payload = String(state.val ?? '');\n\n        // Handle POWER commands\n        if (stateKey.startsWith('POWER')) {\n            payload = state.val ? 'ON' : 'OFF';\n        }\n\n        // Transform shutter state names to correct Tasmota command format\n        const shutterMatch = command.match(/^Shutter(\\d+)[_.]?(Position|Direction|Target|Tilt)$/);\n        if (shutterMatch) {\n            command = `Shutter${shutterMatch[2]}${shutterMatch[1]}`;\n        }\n\n        // Handle object tree state keys (replace dots with underscores for topic)\n        if (this.config.OBJ_TREE) {\n            command = command.replace(/\\./g, '_');\n        }\n\n        const topic = `cmnd/${deviceId}/${command}`;\n        this.log.debug(`Publishing command: ${topic} = ${payload}`);\n        this.mqttClient.publish(topic, payload);\n    }\n}\n\nif (require.main !== module) {\n    module.exports = (options: Partial<AdapterOptions> | undefined) => new SonoffAdapter(options);\n} else {\n    (() => new SonoffAdapter())();\n}\n"]}